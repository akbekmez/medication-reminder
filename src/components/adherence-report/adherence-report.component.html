<div class="fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4 animate-fade-in" (click)="closeModal.emit()">
  <div id="printable-area" class="bg-white rounded-lg shadow-xl w-full max-w-lg relative animate-slide-up printable-modal" (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="flex justify-between items-center p-4 border-b border-gray-200 no-print">
      <div>
        <h3 class="text-lg font-semibold text-gray-800">İlaç Uyum Raporu</h3>
         @if (report(); as r) {
            <p class="text-sm text-gray-500">{{ r.startDate | date:'dd MMM' }} - {{ r.endDate | date:'dd MMM yyyy' }}</p>
         }
      </div>
      <button (click)="closeModal.emit()" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 max-h-[70vh] overflow-y-auto printable-content">
      @if (report(); as r) {
        <div class="print:block hidden mb-4 text-center">
            <h2 class="text-xl font-bold text-gray-800">İlaç Uyum Raporu</h2>
            @if (activeProfile(); as profile) {
              <p class="text-md text-gray-600">{{ profile.name }}</p>
            }
            <p class="text-sm text-gray-500">{{ r.startDate | date:'dd MMMM yyyy' }} - {{ r.endDate | date:'dd MMMM yyyy' }}</p>
        </div>
        @if (r.medications.length > 0) {
           <!-- Overall Score -->
          <div class="flex flex-col items-center justify-center space-y-2 mb-8">
            <div class="relative w-40 h-40">
              <svg class="w-full h-full" viewBox="0 0 120 120">
                <circle
                  class="transform -rotate-90 origin-center"
                  [class]="chartData().trackColorClass"
                  stroke-width="12"
                  stroke="currentColor"
                  fill="transparent"
                  [attr.r]="chartData().radius"
                  cx="60"
                  cy="60"
                />
                <circle
                  class="transform -rotate-90 origin-center transition-all duration-500 ease-out"
                  [class]="chartData().colorClass"
                  stroke-width="12"
                  stroke-linecap="round"
                  stroke="currentColor"
                  fill="transparent"
                  [attr.r]="chartData().radius"
                  cx="60"
                  cy="60"
                  [style.stroke-dasharray]="chartData().circumference"
                  [style.stroke-dashoffset]="chartData().offset"
                />
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-4xl font-bold" [class]="chartData().colorClass">{{ r.overallAdherence }}%</span>
              </div>
            </div>
            <p class="text-lg font-semibold text-gray-700">{{ motivationalMessage() }}</p>
          </div>
          
          <!-- Medication Breakdown -->
          <div class="space-y-4">
            <h4 class="text-md font-semibold text-gray-800 border-b pb-2">İlaç Bazında Döküm</h4>
            @for (med of r.medications; track med.name) {
              <div class="space-y-1">
                <div class="flex justify-between items-baseline">
                  <span class="font-medium text-gray-800">{{ med.name }}</span>
                  <span class="text-sm font-semibold" [class.text-green-600]="med.adherence >= 90" [class.text-yellow-600]="med.adherence >= 70 && med.adherence < 90" [class.text-red-600]="med.adherence < 70">{{ med.adherence }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div class="h-2.5 rounded-full" [style.width.%]="med.adherence" [class.bg-green-500]="med.adherence >= 90" [class.bg-yellow-500]="med.adherence >= 70 && med.adherence < 90" [class.bg-red-500]="med.adherence < 70"></div>
                </div>
                <p class="text-xs text-gray-500 text-right">{{ med.expectedDoses }} dozun {{ med.takenDoses }} tanesi alındı.</p>
              </div>
            }
          </div>

        } @else {
          <div class="text-center text-gray-500 py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-lg font-medium text-gray-900">Rapor Oluşturulamadı</h3>
            <p class="mt-1 text-sm text-gray-500">
              Rapor oluşturmak için takip edilen bir ilaç bulunmuyor.
            </p>
          </div>
        }
      } @else {
         <div class="text-center text-gray-500 py-12">
            <p>Rapor verileri yükleniyor...</p>
         </div>
      }
    </div>

    <!-- Footer -->
    <div class="px-4 py-3 bg-gray-50 flex justify-end items-center sm:px-6 rounded-b-lg no-print">
       <button (click)="printReport()" type="button" class="inline-flex items-center bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
          </svg>
          Yazdır / PDF
        </button>
      <button (click)="closeModal.emit()" type="button" class="ml-3 bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Kapat
      </button>
    </div>

  </div>
</div>
